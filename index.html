<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Game Cast Receiver</title>
    <style>
        body {
            margin: 0;
            background: black;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        video {
            max-width: 100%;
            max-height: 100%;
            background: black;
        }
        #status {
            color: white;
            font-size: 2em;
            position: absolute;
            /* Initially visible */
            display: flex; 
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            background: black;
        }
    </style>
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
    <div id="status">Connecting...</div>
    <video id="remoteVideo" autoplay playsinline></video>

    <script>
        // 1. Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCkkRE9ek2jjkUKTEpxYljx0hTWVMsQjNo",
            authDomain: "webrtc-signalling-24f53.firebaseapp.com",
            databaseURL: "https://webrtc-signalling-24f53-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "webrtc-signalling-24f53",
            storageBucket: "webrtc-signalling-24f53.appspot.com",
            messagingSenderId: "679998066907",
            appId: "1:679998066907:web:0adb3b30d684518680fcfe",
            measurementId: "G-3KWQ9JTCST"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 2. WebRTC Peer Connection setup
        const pc = new RTCPeerConnection({
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        });

        const remoteVideo = document.getElementById("remoteVideo");
        const statusDiv = document.getElementById("status");

        pc.ontrack = event => {
            if (event.streams && event.streams[0] && event.streams[0].getVideoTracks().length > 0) {
                console.log("Received a video stream.");
                remoteVideo.srcObject = event.streams[0];
                statusDiv.style.display = 'none'; // Hide status on success
            } else {
                console.warn("Received a track without a video stream.");
            }
        };

        // 3. WebRTC signaling logic
        async function startWebRtcSignaling() {
            console.log("Receiver starting WebRTC signaling...");

            const callId = "webrtc_call";
            const dbRoot = db.ref("webrtc").child(callId);

            const offerRef = dbRoot.child("offer");
            const answerRef = dbRoot.child("answer");
            const senderCandidatesRef = dbRoot.child("offerCandidates");
            const receiverCandidatesRef = dbRoot.child("answerCandidates");

            await dbRoot.remove();
            console.log("Cleared previous session data.");

            senderCandidatesRef.on("child_added", snapshot => {
                const candidate = snapshot.val();
                if (candidate) {
                    console.log("Got ICE candidate from sender", candidate);
                    pc.addIceCandidate(new RTCIceCandidate(candidate));
                }
            });

            offerRef.on("value", async snapshot => {
                const offer = snapshot.val();
                if (offer) {
                    console.log("Received offer", offer);
                    await pc.setRemoteDescription(new RTCSessionDescription(offer));

                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);

                    answerRef.set(pc.localDescription.toJSON());
                }
            });

            pc.onicecandidate = event => {
                if (event.candidate) {
                    receiverCandidatesRef.push(event.candidate.toJSON());
                }
            };
            
            // Listen for ICE connection state changes to update the status message
            pc.oniceconnectionstatechange = () => {
                const state = pc.iceConnectionState;
                console.log("ICE connection state changed:", state);
                if (state === "disconnected" || state === "failed") {
                    statusDiv.innerText = "Connection failed. Please try again.";
                    statusDiv.style.display = 'flex'; // Show status on failure
                    console.error("WebRTC connection failed.");
                } else if (state === "connected") {
                    statusDiv.innerText = "Connected!";
                    // The ontrack event handler will hide the div once the stream starts
                }
            };
        }

        // 4. Cast Application Framework (CAF) setup
        const castContext = cast.framework.CastReceiverContext.getInstance();
        castContext.start();

        castContext.addEventListener(cast.framework.system.EventType.READY, () => {
            console.log("Cast receiver is ready.");
            startWebRtcSignaling();
        });
    </script>
</body>
</html>
