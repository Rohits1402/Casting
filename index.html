<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Game Cast Receiver</title>
    <style>
        body {
            margin: 0;
            background: black;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        video {
            max-width: 100%;
            max-height: 100%;
            background: black;
        }
        #status {
            color: white;
            font-size: 2em;
            position: absolute;
            display: flex; 
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            background: black;
        }
    </style>
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
</head>
<body>
    <div id="status">Waiting for connection...</div>
    <video id="remoteVideo" autoplay playsinline></video>

    <script>
        // WebRTC Peer Connection setup
        const pc = new RTCPeerConnection({
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" },
                { urls: "stun:stun1.l.google.com:19302" }
            ]
        });

        const remoteVideo = document.getElementById("remoteVideo");
        const statusDiv = document.getElementById("status");
        const castContext = cast.framework.CastReceiverContext.getInstance();

        // WebRTC event handlers
        pc.ontrack = event => {
            if (event.streams && event.streams[0] && event.streams[0].getVideoTracks().length > 0) {
                console.log("Received video stream from Android app");
                remoteVideo.srcObject = event.streams[0];
                statusDiv.style.display = 'none';
                updateStatus("Connected - Streaming video");
            } else {
                console.warn("Received track without video stream");
            }
        };

        pc.onicecandidate = event => {
            if (event.candidate) {
                console.log("Sending ICE candidate to Android app");
                sendToAndroid('ice-candidate', {
                    candidate: event.candidate.toJSON()
                });
            }
        };

        pc.oniceconnectionstatechange = () => {
            const state = pc.iceConnectionState;
            console.log("ICE connection state:", state);
            
            switch(state) {
                case 'connecting':
                    updateStatus("Establishing connection...");
                    break;
                case 'connected':
                    updateStatus("Connected!");
                    break;
                case 'disconnected':
                    updateStatus("Connection lost. Reconnecting...");
                    statusDiv.style.display = 'flex';
                    break;
                case 'failed':
                    updateStatus("Connection failed. Please restart the app.");
                    statusDiv.style.display = 'flex';
                    break;
                case 'closed':
                    updateStatus("Connection closed.");
                    statusDiv.style.display = 'flex';
                    break;
            }
        };

        // Helper function to send messages to Android app
        function sendToAndroid(type, data) {
            const message = { type, data };
            try {
                castContext.sendCustomMessage('urn:x-cast:webrtc.signaling', undefined, message);
            } catch (error) {
                console.error('Failed to send message to Android:', error);
            }
        }

        // Helper function to update status
        function updateStatus(message) {
            statusDiv.innerText = message;
            console.log("Status:", message);
        }

        // WebRTC signaling message handler
        async function handleWebRTCSignaling(event) {
            const { type, data } = event.data;
            console.log("Received WebRTC message:", type);

            try {
                switch(type) {
                    case 'offer':
                        await handleOffer(data);
                        break;
                    case 'ice-candidate':
                        await handleIceCandidate(data);
                        break;
                    case 'connection-test':
                        // Respond to connection test from Android
                        sendToAndroid('connection-test-response', { status: 'ready' });
                        break;
                    default:
                        console.warn('Unknown message type:', type);
                }
            } catch (error) {
                console.error('Error handling WebRTC message:', error);
                updateStatus("Error processing connection data");
            }
        }

        async function handleOffer(offerData) {
            console.log("Processing offer from Android app");
            updateStatus("Processing connection offer...");

            try {
                const offer = new RTCSessionDescription(offerData.offer);
                await pc.setRemoteDescription(offer);

                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);

                // Send answer back to Android
                sendToAndroid('answer', {
                    answer: pc.localDescription.toJSON()
                });

                console.log("Answer sent to Android app");
            } catch (error) {
                console.error("Error creating answer:", error);
                updateStatus("Failed to establish connection");
            }
        }

        async function handleIceCandidate(candidateData) {
            try {
                const candidate = new RTCIceCandidate(candidateData.candidate);
                await pc.addIceCandidate(candidate);
                console.log("Added ICE candidate from Android app");
            } catch (error) {
                console.error("Error adding ICE candidate:", error);
            }
        }

        // Cast Application Framework setup
        castContext.addEventListener(cast.framework.system.EventType.READY, () => {
            console.log("Cast receiver is ready for WebRTC connections");
            updateStatus("Ready for connection from Android app");
        });

        // Listen for custom messages from Android app
        castContext.addCustomMessageListener('urn:x-cast:webrtc.signaling', handleWebRTCSignaling);

        // Handle sender connect/disconnect
        castContext.addEventListener(cast.framework.system.EventType.SENDER_CONNECTED, (event) => {
            console.log("Android app connected:", event.senderId);
            updateStatus("Android app connected. Initializing...");
        });

        castContext.addEventListener(cast.framework.system.EventType.SENDER_DISCONNECTED, (event) => {
            console.log("Android app disconnected:", event.senderId);
            updateStatus("Android app disconnected");
            // Clean up WebRTC connection
            if (pc.connectionState !== 'closed') {
                pc.close();
            }
            remoteVideo.srcObject = null;
            statusDiv.style.display = 'flex';
        });

        // Start the Cast receiver
        castContext.start();

        // Optional: Handle page visibility for cleanup
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && pc.connectionState !== 'closed') {
                console.log("Page hidden, maintaining connection");
            }
        });
    </script>
</body>
</html>
