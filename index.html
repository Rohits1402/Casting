<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>WebRTC Game Receiver</title>
<style>
html, body { height: 100%; margin: 0; background: black; }
#stream { width: 100%; height: 100%; object-fit: contain; background: black; }
#status { position: absolute; top: 8px; left: 8px; color: #0f0; font-family: monospace; }
</style>
</head>
<body>
<div id="status">connecting...</div>
<video id="stream" autoplay playsinline muted></video>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>

<script>
const pcConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const videoEl = document.getElementById('stream');
const statusEl = document.getElementById('status');
function log(msg) { console.log(msg); statusEl.textContent = msg; }

let pc = null;
let pendingOfferCandidates = [];

async function handleOffer(offer) {
  log("Received offer, creating PeerConnection...");
  pc = new RTCPeerConnection(pcConfig);

  pc.ontrack = (event) => {
    log("Track received");
    videoEl.srcObject = event.streams[0];
    videoEl.play().catch(console.error);
  };

  pc.onicecandidate = (event) => {
    if (event.candidate) {
      db.ref("answerCandidates").push(event.candidate.toJSON());
    }
  };

  await pc.setRemoteDescription(offer);
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  db.ref("answer").set(answer);

  pendingOfferCandidates.forEach(c =>
    pc.addIceCandidate(new RTCIceCandidate(c)).catch(console.error)
  );
  pendingOfferCandidates = [];

  log("Answer sent; waiting for media...");
}

function startSignaling() {
  log("Waiting for offer...");
  db.ref("offer").on("value", async (snapshot) => {
    const data = snapshot.val();
    if (data && data.type === "offer") {
      await handleOffer(data);
    }
  });

  db.ref("offerCandidates").on("child_added", (snapshot) => {
    const candidate = snapshot.val();
    if (!candidate) return;
    if (pc) {
      pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(console.error);
    } else {
      pendingOfferCandidates.push(candidate);
    }
  });
}

startSignaling();
</script>
</body>
</html>
